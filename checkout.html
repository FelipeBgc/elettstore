<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout - √âlett Store</title>
  <link rel="stylesheet" href="Css/style.css" media="all" />
  <link rel="shortcut icon" href="imagens/favicon.png" type="image/x-icon">
  <style>

    :root{ /*VARI√ÅVEIS GLOBAIS*/
      --font: "Montserrat",sans-serif;
      --fontP: "Poppins";
      --cor1: #8a8a8a;
      --cor2: #fff;
      --cor3: #000000;
      --cor_text : #000000d2;
      --cor5:#A1A09A;
      --left: 800px;
      --bottom: 800px;
      --cor7: #5bb299!important;
      --topHeaderCel: 5px;
    }

    html { /*CONFIGURA√á√ïES GLOBAIS*/
      scroll-behavior: smooth;
      overflow-x: hidden;
      font: var(--font);
    }

    @font-face { 
      font-family: 'Mignon';
      src: url('fonts/Mignon-Regular.otf') format('opentype'), url('fonts/Mignon-Regular.ttf') format('truetype');
    }

    .logo h1 {
      font-family: 'Mignon';
    }

    header {
      position: static !important;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }

    .checkout-container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
    }

    .checkout-container h2 {
      font-size: 28px;
      color: #333;
      margin-bottom: 50px;
      text-align: center;
    }

    .checkout-content {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 40px;
      margin-top: 30px;
    }

    .checkout-form {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .form-section {
      margin-bottom: 40px;
    }

    .form-section h3 {
      font-size: 18px;
      margin-bottom: 20px;
      color: #333;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 12px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 18px;
    }

    .form-row.full {
      grid-template-columns: 1fr;
      margin-top: 2rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
      font-size: 14px;
    }

    .form-group input,
    .form-group select {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-family: Arial, sans-serif;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #5bb299;
      box-shadow: 0 0 5px rgba(91,178,153,0.3);
    }

    .payment-methods {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .payment-method {
      position: relative;
    }

    .payment-method input[type="radio"] {
      display: none;
    }

    .payment-method label {
      display: block;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 4px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #f9f9f9;
      margin-bottom: 0;
    }

    .payment-method input[type="radio"]:checked + label {
      border-color: #5bb299;
      background: #e8f5f0;
    }

    /* Dropdown de Entrega */
    .delivery-selector {
      position: relative;
      width: 100%;
    }

    .delivery-toggle {
      width: 100%;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 4px;
      background: #f9f9f9;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .delivery-toggle:hover {
      border-color: #5bb299;
      background: #e8f5f0;
    }

    .delivery-toggle.active {
      border-color: #5bb299;
      background: #e8f5f0;
    }

    .delivery-icon {
      font-size: 20px;
    }

    .delivery-name {
      font-weight: bold;
      color: #333;
      flex: 1;
    }

    .delivery-time {
      font-size: 12px;
      color: #999;
      margin-right: 10px;
    }

    .dropdown-arrow {
      font-size: 12px;
      color: #999;
      transition: transform 0.3s ease;
    }

    .delivery-toggle.active .dropdown-arrow {
      transform: rotate(180deg);
    }

    .delivery-options {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #5bb299;
      border-top: none;
      border-radius: 0 0 4px 4px;
      margin-top: -2px;
      padding: 10px;
      z-index: 100;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .delivery-options .payment-methods {
      gap: 8px;
    }

    .delivery-options .payment-method label {
      padding: 12px;
      font-size: 13px;
    }

    .order-summary {
      background: white;
      padding: 35px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      height: fit-content;
      position: sticky;
      top: 20px;
    }

    .order-summary h3 {
      font-size: 18px;
      margin-bottom: 22px;
      color: #333;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 12px;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid #eee;
    }

    .order-item:last-child {
      border-bottom: none;
    }

    .item-details {
      flex: 1;
    }

    .item-name {
      font-weight: bold;
      color: #333;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .item-qty {
      font-size: 12px;
      color: #999;
    }

    .item-price {
      font-weight: bold;
      color: var(--cor_text);
      font-size: 14px;
    }

    .summary-line {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      font-size: 14px;
    }

    .summary-line.total {
      border-top: 2px solid #ddd;
      padding-top: 16px;
      margin-top: 16px;
      margin-bottom: 20px;
      font-size: 18px;
      font-weight: bold;
      color: var(--cor3);
    }

    .order-summary .btn-checkout {
      margin-top: 0;
    }

    .order-summary .btn-back-container {
      margin-top: 10px;
    }

    .btn-checkout {
      width: 100%;
      padding: 16px;
      background-color: #5bb299;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 25px;
      transition: background-color 0.3s ease;
    }

    .btn-checkout:hover {
      background-color: #4a9a7f;
    }

    .btn-back {
      display: inline-block;
      padding: 13px 30px;
      color: #333;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 12px;
      transition: background-color 0.3s ease;
      text-align: center;
    }

    .btn-back:hover {
      background-color: #bbb;
    }

    .btn-back-container {
      text-align: center;
      margin-top: 12px;
    }

    .empty-cart {
      text-align: center;
      padding: 40px 20px;
    }

    .empty-cart h2 {
      color: #999;
      margin-bottom: 20px;
    }

    /* C√°lculo de Frete */
    .shipping-calc-section {
      background-color: #f0f0f0;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 4px;
      border-left: 4px solid #5bb299;
    }

    .shipping-calc-section h4 {
      font-size: 14px;
      font-weight: bold;
      color: #333;
      margin-bottom: 12px;
    }

    .shipping-calc-section p {
      font-size: 12px;
      color: #666;
      margin-bottom: 14px;
      font-style: italic;
    }

    .shipping-input-group {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }

    /* Se√ß√£o PIX */
    .pix-info {
      background: linear-gradient(135deg, #e8f5f0 0%, #f0faf8 100%);
      border: 2px solid #5bb299;
      border-radius: 8px;
      padding: 20px;
      width: 100%;
    }

    .pix-info h4 {
      font-size: 16px;
      color: #333;
      margin-bottom: 15px;
      font-weight: bold;
    }

    .pix-data {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 15px;
    }

    .pix-item {
      background: white;
      padding: 12px;
      border-radius: 4px;
      border-left: 4px solid #5bb299;
    }

    .pix-item label {
      display: block;
      font-weight: bold;
      color: #555;
      font-size: 13px;
      margin-bottom: 5px;
    }

    .pix-value {
      font-size: 14px;
      color: #333;
      font-family: 'Courier New', monospace;
      font-weight: 600;
      word-break: break-all;
    }

    .pix-note {
      font-size: 12px;
      color: #666;
      font-style: italic;
      margin: 10px 0 0 0;
      padding: 10px;
      background: rgba(91, 178, 153, 0.1);
      border-radius: 4px;
    }

    .shipping-input-group input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }

    .shipping-input-group button {
      padding: 10px 18px;
      background-color: #5bb299;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
    }

    .shipping-input-group button:hover {
      background-color: #4a9a7f;
    }

    .shipping-input-group button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .shipping-msg {
      font-size: 12px;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
      display: none;
    }

    .shipping-msg.success {
      background-color: #e8f5e9;
      border: 1px solid #4caf50;
      color: #2e7d32;
    }

    .shipping-msg.error {
      background-color: #ffebee;
      border: 1px solid #f44336;
      color: #c62828;
    }

    /* Tablet e telas m√©dias */
    @media (max-width: 900px) {
      .checkout-container {
        max-width: 100%;
        margin: 30px auto;
        padding: 15px;
      }

      .checkout-container h2 {
        font-size: 24px;
        margin-bottom: 45px;
        margin-top: 1rem;
      }

      .checkout-content {
        grid-template-columns: 1fr;
        gap: 30px;
      }

      .form-row {
        gap: 15px;
        margin-bottom: 15px;
      }

      .form-group input,
      .form-group select {
        padding: 10px;
        font-size: 13px;
      }

      .order-summary {
        position: static;
        padding: 30px;
        margin-top: 20px;
      }

      .payment-methods {
        grid-template-columns: repeat(2, 1fr);
      }

      .shipping-input-group {
        flex-direction: column;
        gap: 10px;
      }

      .shipping-input-group button {
        padding: 12px 15px;
        width: 100%;
      }
    }

    /* Mobile */
    @media (max-width: 767px) {
      .checkout-container {
        max-width: 100%;
        margin: 20px auto;
        padding: 12px;
      }

      .checkout-container h2 {
        font-size: 20px;
        margin-bottom: 40px;
      }

      .checkout-content {
        grid-template-columns: 1fr;
        gap: 20px;
        margin-top: 20px;
      }

      .form-section {
        margin-bottom: 30px;
      }

      .form-section h3 {
        font-size: 16px;
        margin-bottom: 15px;
        padding-bottom: 10px;
      }

      .form-row {
        grid-template-columns: 1fr;
        gap: 12px;
        margin-bottom: 12px;
      }

      .form-group {
        margin-bottom: 0;
      }

      .form-group label {
        margin-bottom: 6px;
        font-size: 13px;
      }

      .form-group input,
      .form-group select {
        padding: 10px;
        font-size: 13px;
        border: 1px solid #ddd;
      }

      .shipping-calc-section {
        padding: 15px;
        margin-bottom: 20px;
      }

      .shipping-calc-section h4 {
        font-size: 13px;
        margin-bottom: 10px;
      }

      .shipping-calc-section p {
        font-size: 11px;
        margin-bottom: 10px;
      }

      .shipping-input-group {
        flex-direction: column;
        gap: 10px;
        margin-bottom: 10px;
      }

      .shipping-input-group input {
        padding: 10px;
        font-size: 13px;
      }

      .shipping-input-group button {
        padding: 12px;
        font-size: 12px;
        width: 100%;
      }

      .payment-methods {
        grid-template-columns: 1fr;
        gap: 8px;
        margin-top: 12px;
      }

      .payment-method label {
        padding: 12px;
        font-size: 12px;
      }

      .order-summary {
        position: static;
        padding: 20px;
        margin-top: 20px;
        border-radius: 6px;
      }

      .order-summary h3 {
        font-size: 16px;
        margin-bottom: 15px;
        padding-bottom: 10px;
      }

      .order-item {
        padding: 10px 0;
      }

      .item-name {
        font-size: 13px;
        margin-bottom: 3px;
      }

      .item-qty {
        font-size: 11px;
      }

      .item-price {
        font-size: 13px;
      }

      .summary-line {
        padding: 10px 0;
        font-size: 13px;
      }

      .summary-line.total {
        padding-top: 12px;
        margin-top: 12px;
        font-size: 16px;
      }

      .btn-checkout {
        padding: 14px;
        font-size: 15px;
        margin-top: 20px;
      }

      .btn-back {
        padding: 11px 20px;
        font-size: 13px;
      }

      .delivery-toggle {
        padding: 12px;
        font-size: 13px;
        gap: 8px;
      }

      .delivery-icon {
        font-size: 18px;
      }

      .delivery-time {
        font-size: 11px;
      }

      .delivery-options .payment-method label {
        padding: 10px;
        font-size: 12px;
      }
    }
  </style>
</head>

<body>

  <!--Cabe√ßalho-->
  <header>
    <!--Logo-->
    <div class="logo">
      <p>¬¥</p>
      <a href="index.html"> 
        <h1>√âlett Store</h1>
      </a>
    </div>
    <!--Fim logo-->
  </header>
  <!--Fim cabe√ßalho-->

  <div class="checkout-container">
    <h2>Finalizar Compra</h2>

    <div id="empty-message" class="empty-cart" style="display: none;">
      <h2>Seu carrinho est√° vazio</h2>
      <a href="index.html" class="btn-back">Voltar para Loja</a>
    </div>

    <div id="checkout-content" class="checkout-content">
      <!-- Formul√°rio de Checkout -->
      <form id="checkout-form">
        
        <!-- Se√ß√£o de Endere√ßo de Entrega -->
        <div class="form-section">
          <h3>Endere√ßo de Entrega</h3>
          
          <div class="form-row full">
            <div class="form-group">
              <label for="fullname">Nome Completo *</label>
              <input type="text" id="fullname" name="fullname" placeholder="Digite seu nome completo" required autocomplete="none">
            </div>
          </div>

          <div class="form-row full">
            <div class="form-group">
              <label for="email">E-mail *</label>
              <input type="email" id="email" name="email" placeholder="seu.email@example.com" required>
            </div>
          </div>

          <div class="form-row full">
            <div class="form-group">
              <label for="phone">Telefone *</label>
              <input type="tel" id="phone" name="phone" placeholder="(11) 98765-4321" required>
            </div>
          </div>


          <div class="form-row full">
            <div class="form-group">
              <label for="address">Rua/Avenida *</label>
              <input type="text" id="address" name="address" placeholder="Rua, Avenida ou Alameda" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="number">N√∫mero *</label>
              <input type="text" id="number" name="number" placeholder="Ex: 248" required>
            </div>
            <div class="form-group">
              <label for="complement">Complemento</label>
              <input type="text" id="complement" name="complement" placeholder="Apto, sala, loja, etc.">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="neighborhood">Bairro *</label>
              <input type="text" id="neighborhood" name="neighborhood" placeholder="Nome do bairro" required>
            </div>
            <div class="form-group">
              <label for="city">Cidade *</label>
              <input type="text" id="city" name="city" placeholder="Sua cidade" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="state">Estado *</label>
              <select id="state" name="state" required>
                <option value="">Selecione um estado</option>
                <option value="AC">Acre</option>
                <option value="AL">Alagoas</option>
                <option value="AP">Amap√°</option>
                <option value="AM">Amazonas</option>
                <option value="BA">Bahia</option>
                <option value="CE">Cear√°</option>
                <option value="DF">Distrito Federal</option>
                <option value="ES">Esp√≠rito Santo</option>
                <option value="GO">Goi√°s</option>
                <option value="MA">Maranh√£o</option>
                <option value="MT">Mato Grosso</option>
                <option value="MS">Mato Grosso do Sul</option>
                <option value="MG">Minas Gerais</option>
                <option value="PA">Par√°</option>
                <option value="PB">Para√≠ba</option>
                <option value="PR">Paran√°</option>
                <option value="PE">Pernambuco</option>
                <option value="PI">Piau√≠</option>
                <option value="RJ">Rio de Janeiro</option>
                <option value="RN">Rio Grande do Norte</option>
                <option value="RS">Rio Grande do Sul</option>
                <option value="RO">Rond√¥nia</option>
                <option value="RR">Roraima</option>
                <option value="SC">Santa Catarina</option>
                <option value="SP">S√£o Paulo</option>
                <option value="SE">Sergipe</option>
                <option value="TO">Tocantins</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Se√ß√£o de M√©todo de Entrega -->
        <div class="form-section">
          <h3>M√©todo de Entrega</h3>
          
          <div class="form-row full">
            <div class="form-group">
              <div class="delivery-selector">
                <button type="button" class="delivery-toggle" id="delivery-toggle">
                  <span class="delivery-icon">üì¶</span>
                  <span class="delivery-name">Normal</span>
                  <span class="delivery-time">7-15 dias</span>
                  <span class="dropdown-arrow">‚ñº</span>
                </button>
                
                <div class="delivery-options" id="delivery-options" style="display: none;">
                  <div class="payment-methods">
                    <div class="payment-method">
                      <input type="radio" id="delivery-normal" name="delivery" value="normal" checked>
                      <label for="delivery-normal">
                        <div>üì¶</div>
                        <div>Normal</div>
                        <div style="font-size: 11px;">7-15 dias</div>
                      </label>
                    </div>
                    <div class="payment-method">
                      <input type="radio" id="delivery-sedex" name="delivery" value="sedex">
                      <label for="delivery-sedex">
                        <div>üöö</div>
                        <div>SEDEX</div>
                        <div style="font-size: 11px;">2-5 dias</div>
                      </label>
                    </div>
                  </div>
                </div>
              </div>

               <div class="form-row full">
            <div class="form-group">
              <label for="checkout-cep">CEP para C√°lculo de Frete *</label>
              <small style="color: #999; font-size: 12px; margin-bottom: 5px; display: block;">De: Rua S√£o Benedito, MG (CEP: 37160-000)</small>
              <div class="shipping-input-group">
                <input type="text" id="checkout-cep" name="checkout-cep" placeholder="37270-000" maxlength="9" required>
                <button type="button" id="calc-shipping-btn">Calcular Frete</button>
              </div>
              <div id="shipping-msg" class="shipping-msg"></div>
            </div>
          </div>

            </div>
          </div>
        </div>

        <!-- Se√ß√£o de M√©todo de Pagamento -->
        <div class="form-section">
          <h3>M√©todo de Pagamento</h3>
          
          <div class="form-row full">
            <div class="form-group">
              <div class="payment-methods">
                <div class="payment-method">
                  <input type="radio" id="payment-credit" name="payment" value="credit" checked required>
                  <label for="payment-credit">
                    <div>üí≥</div>
                    <div>Cr√©dito</div>
                  </label>
                </div>
                <div class="payment-method">
                  <input type="radio" id="payment-debit" name="payment" value="debit">
                  <label for="payment-debit">
                    <div>üè¶</div>
                    <div>D√©bito</div>
                  </label>
                </div>
                <div class="payment-method">
                  <input type="radio" id="payment-pix" name="payment" value="pix">
                  <label for="payment-pix">
                    <div>üì±</div>
                    <div>PIX</div>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Se√ß√£o de PIX -->
          <div id="pix-section" style="display: none;">
            <div class="form-row full" style="margin-top: 20px;">
              <div class="pix-info">
                <h4>üì± Dados para Pagamento via PIX</h4>
                <div class="pix-data">
                  <div class="pix-item">
                    <label>Chave PIX:</label>
                    <div class="pix-value">(35)98839-7718</div>
                  </div>
                  <div class="pix-item">
                    <label>Nome do Benefici√°rio:</label>
                    <div class="pix-value">Leticia de Castro Reis</div>
                  </div>
                  <div class="pix-item">
                    <label>CPF:</label>
                    <div class="pix-value">143.449.946-47</div>
                  </div>
                  <div class="pix-item">
                    <label>Banco:</label>
                    <div class="pix-value">Nubank</div>
                  </div>
                </div>
                <p class="pix-note">* Ap√≥s confirmar o pedido, voc√™ receber√° o QR Code via e-mail para realizar o pagamento</p>
              </div>
            </div>
          </div>

          <!-- Campos de Cart√£o -->
          <div id="card-section">
            <div class="form-row full" style="margin-top: 20px;">
              <div class="form-group">
                <label for="card-number">N√∫mero do Cart√£o *</label>
                <input type="text" id="card-number" name="card-number" placeholder="1234 5678 9101 1121" maxlength="19">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="card-holder">Titular *</label>
                <input type="text" id="card-holder" name="card-holder" placeholder="NOME COMPLETO NO CARTAO">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="card-expiry">Vencimento *</label>
                <input type="text" id="card-expiry" name="card-expiry" placeholder="12/25" maxlength="5">
              </div>
              <div class="form-group">
                <label for="card-cvv">CVV *</label>
                <input type="text" id="card-cvv" name="card-cvv" placeholder="123" maxlength="3">
              </div>
            </div>
          </div>
        </div>
      </form>

      <!-- Resumo do Pedido -->
      <div class="order-summary">
        <h3>Resumo do Pedido</h3>
        <div id="order-items"></div>

        <div class="summary-line">
          <span>Subtotal:</span>
          <span id="subtotal">R$ 0,00</span>
        </div>

        <div class="summary-line">
          <span>Frete:</span>
          <span id="shipping">R$ 0,00</span>
        </div>

        <div class="summary-line total">
          <span>Total:</span>
          <span id="total">R$ 0,00</span>
        </div>

        <button type="submit" form="checkout-form" class="btn-checkout">Confirmar Pedido</button>
        
        <div class="btn-back-container">
          <a href="index.html" class="btn-back">Voltar para Loja</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configura√ß√£o dos Correios
    const SENDER_CEP = '37160-000'; // CEP do remetente (37160-000)
    const CORREIOS_SERVICES = {
      'pac': '04014', // Correios PAC
      'sedex': '04162' // Correios SEDEX
    };

    // Recuperar carrinho do localStorage
    function loadCartFromStorage() {
      const cart = localStorage.getItem('cart');
      return cart ? JSON.parse(cart) : [];
    }

    // Recuperar produtos do JSON
    async function loadProducts() {
      try {
        const response = await fetch('products.json');
        return await response.json();
      } catch (error) {
        console.error('Erro ao carregar produtos:', error);
        return [];
      }
    }

    // Calcular peso total do carrinho
    function getTotalWeight() {
      const carts = loadCartFromStorage();
      let totalWeight = 0;
      
      // Peso padr√£o por produto em kg
      const defaultWeight = 0.5;
      
      carts.forEach(item => {
        totalWeight += (item.quantity || 1) * defaultWeight;
      });
      
      // Peso m√≠nimo √© 300g para a API dos Correios
      return Math.max(totalWeight * 1000, 300); // retorna em gramas
    }

    // Calcular frete via Correios
    async function calculateShippingCorreios(destCep) {
      try {
        const weight = getTotalWeight();
        const destCepClean = destCep.replace('-', '').replace(/\D/g, '');
        
        if (destCepClean.length < 8) {
          showShippingMessage('CEP inv√°lido', false);
          return null;
        }

        // Usando a API p√∫blica dos Correios (sem autentica√ß√£o)
        const url = `https://viacep.com.br/ws/${destCepClean}/json/`;
        
        const response = await fetch(url);
        const data = await response.json();

        if (data.erro) {
          showShippingMessage('CEP n√£o encontrado', false);
          return null;
        }

        // Retornar dados do CEP
        return {
          city: data.localidade,
          state: data.uf,
          cep: destCepClean
        };
      } catch (error) {
        console.error('Erro ao consultar frete:', error);
        showShippingMessage('Erro ao calcular frete. Tente novamente.', false);
        return null;
      }
    }

    // Inicializar checkout
    async function initCheckout() {
      const carts = loadCartFromStorage();
      const products = await loadProducts();

      if (carts.length === 0) {
        document.getElementById('checkout-content').style.display = 'none';
        document.getElementById('empty-message').style.display = 'block';
        return;
      }

      let subtotal = 0;
      let orderItemsHTML = '';

      carts.forEach(cartItem => {
        const product = products.find(p => p.id == cartItem.product_id);
        if (product) {
          const itemTotal = product.price * cartItem.quantity;
          subtotal += itemTotal;

          orderItemsHTML += `
            <div class="order-item">
              <div class="item-details">
                <div class="item-name">${product.name}</div>
                <div class="item-qty">Qtd: ${cartItem.quantity}</div>
              </div>
              <div class="item-price">R$ ${itemTotal.toFixed(2).replace('.', ',')}</div>
            </div>
          `;
        }
      });

      document.getElementById('order-items').innerHTML = orderItemsHTML;
      updateTotals(subtotal);
    }

    // Atualizar totais
    function updateTotals(subtotal, cepShipping = 0) {
      const deliveryType = document.querySelector('input[name="delivery"]:checked').value;
      const deliveryFees = {
        normal: 0.00,
        sedex: 0.00
      };
      
      const totalShipping = cepShipping + (deliveryFees[deliveryType] || 0);
      const total = subtotal + totalShipping;

      document.getElementById('subtotal').textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
      document.getElementById('shipping').textContent = `R$ ${totalShipping.toFixed(2).replace('.', ',')}`;
      document.getElementById('total').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
    }

    // Calcular frete por CEP (usando Correios)
    async function calculateShipping() {
      const cepInput = document.getElementById('checkout-cep');
      let cep = cepInput.value.trim();
      
      if (!cep || cep.length < 8) {
        showShippingMessage('Digite um CEP v√°lido', false);
        return;
      }

      const msgDiv = document.getElementById('shipping-msg');
      msgDiv.textContent = '‚è≥ Calculando frete...';
      msgDiv.classList.remove('error', 'success');
      msgDiv.style.display = 'block';

      const cepInfo = await calculateShippingCorreios(cep);
      
      if (cepInfo) {
        const deliveryType = document.querySelector('input[name="delivery"]:checked').value;
        
        // Tabela de fretes estimados por regi√£o (em reais)
        const freteEstimado = calculateEstimatedShipping(cepInfo.state, deliveryType);
        
        msgDiv.textContent = `‚úì ${cepInfo.city} - ${cepInfo.state} | Frete: R$ ${freteEstimado.toFixed(2).replace('.', ',')}`;
        msgDiv.classList.add('success');
        msgDiv.classList.remove('error');
        msgDiv.style.display = 'block';
        
        localStorage.setItem('checkout-shipping-cost', freteEstimado);
        const subtotal = parseFloat(document.getElementById('subtotal').textContent.replace('R$ ', '').replace(',', '.'));
        updateTotals(subtotal, freteEstimado);
      }
    }

    // Calcular frete estimado por regi√£o
    function calculateEstimatedShipping(state, deliveryType) {
      // Tabela de fretes regionais baseada nos Correios
      const fretesPorRegiao = {
        'MG': { pac: 21.00, sedex: 65.00 },
        'SP': { pac: 22.00, sedex: 65.00 },
        'RJ': { pac: 21.00, sedex: 65.00 },
        'BA': { pac: 28.00, sedex: 65.00 },
        'PE': { pac: 31.00, sedex: 65.00 },
        'CE': { pac: 32.00, sedex: 65.00 },
        'PA': { pac: 38.00, sedex: 65.00 },
        'AM': { pac: 42.00, sedex: 65.00 },
        'MT': { pac: 29.00, sedex: 65.00 },
        'GO': { pac: 25.00, sedex: 65.00 },
        'DF': { pac: 24.00, sedex: 65.00 },
        'ES': { pac: 20.00, sedex: 65.00 },
        'PR': { pac: 23.00, sedex: 65.00 },
        'SC': { pac: 24.00, sedex: 65.00 },
        'RS': { pac: 25.00, sedex: 65.00 }
      };

      const tipoEntrega = deliveryType === 'normal' ? 'pac' : 'sedex';
      const fretes = fretesPorRegiao[state] || { pac: 35.00, sedex: 65.00 }; // Padr√£o para outras regi√µes
      
      return fretes[tipoEntrega] || 35.00;
    }

    function showShippingMessage(message, isSuccess) {
      const msgDiv = document.getElementById('shipping-msg');
      msgDiv.textContent = `‚úï ${message}`;
      msgDiv.classList.add('error');
      msgDiv.classList.remove('success');
      msgDiv.style.display = 'block';
    }

    // Formatar CEP
    document.getElementById('checkout-cep').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length <= 5) {
        e.target.value = value;
      } else {
        e.target.value = value.substring(0, 5) + '-' + value.substring(5, 8);
      }
    });

    // Bot√£o calcular frete
    document.getElementById('calc-shipping-btn').addEventListener('click', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('calc-shipping-btn');
      btn.disabled = true;
      btn.textContent = 'Calculando...';
      await calculateShipping();
      btn.disabled = false;
      btn.textContent = 'Calcular Frete';
    });

    // Enter para calcular
    document.getElementById('checkout-cep').addEventListener('keypress', async (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const btn = document.getElementById('calc-shipping-btn');
        btn.disabled = true;
        btn.textContent = 'Calculando...';
        await calculateShipping();
        btn.disabled = false;
        btn.textContent = 'Calcular Frete';
      }
    });

    // Evento de entrega
    document.querySelectorAll('input[name="delivery"]').forEach(radio => {
      radio.addEventListener('change', () => {
        updateDeliveryToggle(radio.value);
        document.getElementById('checkout-cep').value = '';
        document.getElementById('shipping-msg').style.display = 'none';
        closeDeliveryDropdown();
      });
    });

    // Controlar dropdown de entrega
    const deliveryToggle = document.getElementById('delivery-toggle');
    const deliveryOptions = document.getElementById('delivery-options');

    deliveryToggle.addEventListener('click', (e) => {
      e.preventDefault();
      if (deliveryOptions.style.display === 'none') {
        deliveryOptions.style.display = 'block';
        deliveryToggle.classList.add('active');
      } else {
        closeDeliveryDropdown();
      }
    });

    // Fechar dropdown quando clicar fora
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.delivery-selector')) {
        closeDeliveryDropdown();
      }
    });

    function closeDeliveryDropdown() {
      deliveryOptions.style.display = 'none';
      deliveryToggle.classList.remove('active');
    }

    function updateDeliveryToggle(value) {
      const deliveryData = {
        'normal': { icon: 'üì¶', name: 'Normal', time: '7-15 dias' },
        'sedex': { icon: 'üöö', name: 'SEDEX', time: '2-5 dias' },
        'motoboy': { icon: 'üèçÔ∏è', name: 'Motoboy', time: 'Mesmo dia' }
      };

      const data = deliveryData[value];
      if (data) {
        document.querySelector('.delivery-icon').textContent = data.icon;
        document.querySelector('.delivery-name').textContent = data.name;
        document.querySelector('.delivery-time').textContent = data.time;
      }
    }

    // Ocultar campos de cart√£o se n√£o for cr√©dito/d√©bito
    // Mostrar PIX se for PIX
    document.querySelectorAll('input[name="payment"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const cardSection = document.getElementById('card-section');
        const pixSection = document.getElementById('pix-section');
        
        if (this.value === 'credit' || this.value === 'debit') {
          cardSection.style.display = 'block';
          pixSection.style.display = 'none';
        } else if (this.value === 'pix') {
          cardSection.style.display = 'none';
          pixSection.style.display = 'block';
        } else {
          cardSection.style.display = 'none';
          pixSection.style.display = 'none';
        }
      });
    });

    // Formatar cart√£o
    document.getElementById('card-number').addEventListener('input', function() {
      this.value = this.value.replace(/\s/g, '').replace(/(\d{4})/g, '$1 ').trim();
    });

    document.getElementById('card-expiry').addEventListener('input', function() {
      this.value = this.value.replace(/\D/g, '').replace(/(\d{2})(\d)/, '$1/$2');
    });

    document.getElementById('card-cvv').addEventListener('input', function() {
      this.value = this.value.replace(/\D/g, '');
    });

    // Submeter formul√°rio
    document.getElementById('checkout-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Valida√ß√£o de campos obrigat√≥rios de endere√ßo
      const fullname = document.getElementById('fullname').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const cep = document.getElementById('cep').value.trim();
      const address = document.getElementById('address').value.trim();
      const number = document.getElementById('number').value.trim();
      const neighborhood = document.getElementById('neighborhood').value.trim();
      const city = document.getElementById('city').value.trim();
      const state = document.getElementById('state').value.trim();

      // Valida√ß√£o de CEP de frete calculado
      const checkoutCep = document.getElementById('checkout-cep').value.trim();
      const shippingCost = localStorage.getItem('checkout-shipping-cost');

      // Valida√ß√£o de m√©todo de entrega
      const deliverySelected = document.querySelector('input[name="delivery"]:checked');

      // Valida√ß√£o de m√©todo de pagamento
      const paymentSelected = document.querySelector('input[name="payment"]:checked');

      // Valida√ß√£o de cart√£o (se cr√©dito ou d√©bito)
      const cardNumber = document.getElementById('card-number').value.trim();
      const cardHolder = document.getElementById('card-holder').value.trim();
      const cardExpiry = document.getElementById('card-expiry').value.trim();
      const cardCvv = document.getElementById('card-cvv').value.trim();

      // Valida√ß√µes
      if (!fullname) {
        alert('Por favor, preencha o nome completo');
        return;
      }

      if (!email) {
        alert('Por favor, preencha o e-mail');
        return;
      }

      if (!phone) {
        alert('Por favor, preencha o telefone');
        return;
      }

      if (!cep) {
        alert('Por favor, preencha o CEP');
        return;
      }

      if (!address) {
        alert('Por favor, preencha a rua/avenida');
        return;
      }

      if (!number) {
        alert('Por favor, preencha o n√∫mero');
        return;
      }

      if (!neighborhood) {
        alert('Por favor, preencha o bairro');
        return;
      }

      if (!city) {
        alert('Por favor, preencha a cidade');
        return;
      }

      if (!state) {
        alert('Por favor, selecione um estado');
        return;
      }

      if (!checkoutCep) {
        alert('Por favor, preencha o CEP para c√°lculo de frete');
        return;
      }

      if (!shippingCost) {
        alert('Por favor, clique em "Calcular Frete" para validar o CEP');
        return;
      }

      if (!deliverySelected) {
        alert('Por favor, selecione um m√©todo de entrega');
        return;
      }

      if (!paymentSelected) {
        alert('Por favor, selecione um m√©todo de pagamento');
        return;
      }

      // Validar campos de cart√£o se for cr√©dito ou d√©bito
      if (paymentSelected.value === 'credit' || paymentSelected.value === 'debit') {
        if (!cardNumber) {
          alert('Por favor, preencha o n√∫mero do cart√£o');
          return;
        }

        if (!cardHolder) {
          alert('Por favor, preencha o titular do cart√£o');
          return;
        }

        if (!cardExpiry) {
          alert('Por favor, preencha o vencimento do cart√£o');
          return;
        }

        if (!cardCvv) {
          alert('Por favor, preencha o CVV do cart√£o');
          return;
        }

        // Validar formato do cart√£o (19 caracteres com espa√ßos)
        if (cardNumber.length < 19) {
          alert('Por favor, preencha o cart√£o completo');
          return;
        }

        // Validar formato da validade (5 caracteres MM/AA)
        if (!cardExpiry.match(/^\d{2}\/\d{2}$/)) {
          alert('Por favor, use o formato MM/AA para o vencimento');
          return;
        }

        // Validar CVV (3 ou 4 d√≠gitos)
        if (cardCvv.length < 3) {
          alert('Por favor, preencha o CVV completo');
          return;
        }
      }

      alert('Pedido realizado com sucesso!\n\nN√∫mero: #' + Math.floor(Math.random() * 1000000) + '\n\nVoc√™ receber√° um e-mail de confirma√ß√£o em breve.');
      
      localStorage.removeItem('cart');
      localStorage.removeItem('checkout-shipping-cost');
      window.location.href = 'index.html';
    });

    // Inicializar
    initCheckout();
  </script>

</body>

</html>
